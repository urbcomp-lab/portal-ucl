name: ğŸš€ Deploy website on push
on:
  push:
    branches: [ main ]
jobs:
  web-deploy:
    name: ğŸ‰ Deploy
    runs-on: ubuntu-latest
    steps:
      - name: ğŸšš Get latest code
        uses: actions/checkout@v3

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: ğŸ“¦ Install Node dependencies
        run: npm ci

      - name: ğŸ“š Generate publications.json file
        run: |
          sudo apt-get update && sudo apt-get install -y libxml2-utils xsltproc
          xmllint --noout curriculo.xml
          node bibToJSON.js curriculo.xml
          echo "--- Verifying publications.json was created ---"
          ls -la publications.json

      - name: ğŸ˜ Setup PHP and Composer
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
      - name: ğŸ“¦ Install Composer Dependencies
        uses: ramsey/composer-install@v2
        with:
          dependency-versions: "locked"

      - name: ğŸš€ Deploy all files to production server
        run: |
          sudo apt-get install -y lftp
          lftp -c "set ftp:ssl-allow no; \
                   open -u ${{ secrets.FTP_USERNAME }},${{ secrets.FTP_PASSWORD }} ${{ secrets.FTP_SERVER }}; \
                   mirror --ignore-time --reverse --delete --verbose \
                          --exclude .git* \
                          --exclude .github* \
                          --exclude node_modules/ \
                          . \
                          /sharedirs/sharedir01/adriano.maia/public_html/"
