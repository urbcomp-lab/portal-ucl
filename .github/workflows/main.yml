name: ðŸš€ Deploy website on push
on:
  push:
    branches: [ main ]
jobs:
  web-deploy:
    name: ðŸŽ‰ Build and Deploy
    runs-on: ubuntu-latest
    steps:
      - name: ðŸšš Get latest code
        uses: actions/checkout@v3

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: ðŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'

      - name: ðŸ“š Prepare static HTML from publications
        run: |
          npm ci

          echo "--- Generating publications.json ---"
          node bibToJSON.js curriculo.xml

          echo "--- Generating publications.html ---"
          php -f publications.php > publications.html

          echo "--- Injecting HTML into index.php ---"
          sed -i '/<?php include "publications.php" ?>/{
            r publications.html
            d
          }' index.php
          echo "--- Injection complete. index.php is now static. ---"

      - name: ðŸš€ Deploy essential files to production
        run: |
          sudo apt-get update && sudo apt-get install -y lftp
          lftp -c "set ftp:ssl-allow no; \
                   open -u ${{ secrets.FTP_USERNAME }},${{ secrets.FTP_PASSWORD }} ${{ secrets.FTP_SERVER }}; \
                   mirror --ignore-time --reverse --delete --verbose \
                          --exclude .git* \
                          --exclude .github* \
                          --exclude node_modules/ \
                          --exclude vendor/ \
                          --exclude curriculo.xml \
                          --exclude bibToJSON.js \
                          --exclude publications.php \
                          --exclude publications.html \
                          --exclude publications.json \
                          --exclude composer.* \
                          . \
                          /sharedirs/sharedir01/adriano.maia/public_html/"
